# Copyright 2019 WSO2, Inc. (http://wso2.com)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License
# ----------------------------------------------------------------------
---
# command line arguments
params:
  wso2is: wso2is-5.8.0
  wso2is-analytics: wso2is-analytics-5.8.0
  existing_version_wso2is: 5.7.0
  new_version_wso2is: 5.8.0
  existing_version_wso2is-analytics: 5.7.0
  new_version_wso2is-analytics: 5.8.0
# files based configurations
files:
#  - file_path: helm/is/is/Chart.yaml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"
#  - file_path: helm/is/is/confs/axis2/axis2.xml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"
#  - file_path: helm/is/is/confs/carbon.xml
#    relative_path: ~
#    file_type: xml
#    configurations:
#      - operation: replace
#        xpath: "Version"
#        value: "{$arg.new_version}"
#  - file_path: helm/is/is/templates/identity-server-deployment.yaml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"
#  - file_path: helm/is-with-analytics/is-with-analytics/Chart.yaml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"
#  - file_path: helm/is-with-analytics/is-with-analytics/confs/is/conf/axis2/axis2.xml
#    relative_path: ~
#    file_type: xml
#    configurations:
#      - operation: replace
#        xpath: "parameter[@name=\"userAgent\"]"
#        value: "WSO2 Identity Server-{$arg.new_version}"
#      - operation: replace
#        xpath: "parameter[@name=\"server\"]"
#        value: "WSO2 Identity Server-{$arg.new_version}"
#  - file_path: helm/is-with-analytics/is-with-analytics/confs/is/conf/carbon.xml
#    relative_path: ~
#    file_type: xml
#    configurations:
#      - operation: replace
#        xpath: "Version"
#        value: "{$arg.new_version}"
#  - file_path: helm/is-with-analytics/is-with-analytics/templates/identity-server-analytics-1-deployment.yaml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"
#  - file_path: helm/is-with-analytics/is-with-analytics/templates/identity-server-analytics-2-deployment.yaml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"
#  - file_path: helm/is-with-analytics/is-with-analytics/templates/identity-server-dashboard-deployment.yaml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"
#  - file_path: helm/is-with-analytics/is-with-analytics/templates/identity-server-deployment.yaml
#    relative_path: ~
#    file_type: txt
#    configurations:
#      - operation: replace
#        current_value: "{$arg.existing_version}"
#        new_value: "{$arg.new_version}"

    - file_path: "is/confs/axis2/axis2.xml"
      relative_path: "{$arg.wso2is}/repository/conf/axis2/axis2.xml"
      file_type: xml
      configurations:
        - operation: "attribute"
          xpath: "clustering[@class=\"org.wso2.carbon.core.clustering.hazelcast.HazelcastClusteringAgent\"]"
          value: "enable=true"
        - operation: replace
          xpath: "clustering/parameter[@name=\"membershipScheme\"]"
          value: "kubernetes"
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="membershipSchemeClassName">org.wso2.carbon.membership.scheme.kubernetes.KubernetesMembershipScheme</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="KUBERNETES_NAMESPACE">wso2</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="KUBERNETES_SERVICES">wso2is-service</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="KUBERNETES_MASTER_SKIP_SSL_VERIFICATION">true</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="USE_DNS">false</parameter>
        - operation: replace
          xpath: "clustering/parameter[@name=\"domain\"]"
          value: "wso2.is.domain"
        - operation: replace
          xpath: "clustering/parameter[@name=\"localMemberHost\"]"
          value: "identity-server"
        - operation: "comment"
          xpath: "clustering/members"
          value: ~
    - file_path: "is/confs/datasources/master-datasources.xml"
      relative_path: "{$arg.wso2is}/repository/conf/datasources/master-datasources.xml"
      file_type: "xml"
      configurations:
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_REG_DS</name>
                <description>The datasource used for registry</description>
                <jndiConfig>
                    <name>jdbc/WSO2RegDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-rdbms-service:3306/WSO2IS_REG_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_USER_DS</name>
                <description>The datasource used for user management</description>
                <jndiConfig>
                    <name>jdbc/WSO2UserDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-rdbms-service:3306/WSO2IS_USER_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_IDENTITY_DS</name>
                <description>The datasource used for identity management</description>
                <jndiConfig>
                    <name>jdbc/WSO2IdentityDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-rdbms-service:3306/WSO2IS_IDENTITY_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_CONSENT_DS</name>
                <description>The datasource used for consent management</description>
                <jndiConfig>
                    <name>jdbc/WSO2ConsentDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-rdbms-service:3306/WSO2IS_CONSENT_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
    - file_path: "is/confs/datasources/bps-datasources.xml"
      relative_path: "{$arg.wso2is}/repository/conf/datasources/bps-datasources.xml"
      file_type: "xml"
      configurations:
        - operation: comment
          xpath: "datasources/datasource[name=\"BPS_DS\"]"
          value: ~
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>BPS_DS</name>
                <description></description>
                <jndiConfig>
                    <name>bpsds</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-rdbms-service:3306/WSO2IS_BPS_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>100</maxActive>
                        <maxWait>10000</maxWait>
                        <maxIdle>20</maxIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <useDataSourceFactory>false</useDataSourceFactory>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
    - file_path: "is/confs/identity/identity.xml"
      relative_path: "{$arg.wso2is}/repository/conf/identity/identity.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "JDBCPersistenceManager/DataSource/Name"
          value: 'jdbc/WSO2IdentityDS'
    # TODO: listener configurations

    - file_path: "is/confs/carbon.xml"
      relative_path: "{$arg.wso2is}/repository/conf/carbon.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "HostName"
          value: "wso2is"
        - operation: replace
          xpath: "MgtHostName"
          value: "wso2is"
    - file_path: "is/confs/consent-mgt-config.xml"
      relative_path: "{$arg.wso2is}/repository/conf/consent-mgt-config.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "DataSource/Name"
          value: 'jdbc/WSO2ConsentDS'
    - file_path: "is/confs/log4j.properties"
      relative_path: "{$arg.wso2is}/repository/conf/log4j.properties"
      file_type: "txt"
      configurations:
        - operation: add
          current_value: "java.util.logging.ConsoleHandler.level=SEVERE"
          new_value: "log4j.logger.com.hazelcast=INFO"
    - file_path: "is/confs/registry.xml"
      relative_path: "{$arg.wso2is}/repository/conf/registry.xml"
      file_type: "xml"
      configurations:
        - operation: add
          xpath: "."
          value:
            |
            <dbConfig name="sharedregistry">
                <dataSource>jdbc/WSO2RegDS</dataSource>
            </dbConfig>
        - operation: add
          xpath: "."
          value:
            |
            <remoteInstance url="https://localhost:9443/registry">
                <id>sharedregistry</id>
                <dbConfig>sharedregistry</dbConfig>
                <readOnly>false</readOnly>
                <registryRoot>/</registryRoot>
                <enableCache>true</enableCache>
                <cacheId>jdbc:mysql://wso2is-rdbms-service:3306/WSO2IS_IDENTITY_DB</cacheId>
            </remoteInstance>
        - operation: add
          xpath: "."
          value:
            |
            <mount path="/_system/config" overwrite="true">
                <instanceId>sharedregistry</instanceId>
                <targetPath>/_system/config</targetPath>
            </mount>
        - operation: add
          xpath: "."
          value:
            |
            <mount path="/_system/governance" overwrite="true">
                <instanceId>sharedregistry</instanceId>
                <targetPath>/_system/governance</targetPath>
            </mount>
    - file_path: "is/confs/user-mgt.xml"
      relative_path: "{$arg.wso2is}/repository/conf/user-mgt.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "Realm/Configuration/Property[@name=\"dataSource\"]"
          value: "jdbc/WSO2IdentityDS"
        - operation: add
          xpath: "Realm"
          value:
            |
            <UserStoreManager class="org.wso2.carbon.user.core.jdbc.JDBCUserStoreManager">
              <Property name="TenantManager">org.wso2.carbon.user.core.tenant.JDBCTenantManager</Property>
              <Property name="dataSource">jdbc/WSO2UserDS</Property>
              <Property name="ReadOnly">false</Property>
              <Property name="ReadGroups">true</Property>
              <Property name="WriteGroups">true</Property>
              <Property name="UsernameJavaRegEx">^[\S]{3,30}$</Property>
              <Property name="UsernameJavaScriptRegEx">^[\S]{3,30}$</Property>
              <Property name="UsernameJavaRegExViolationErrorMsg">Username pattern policy violated</Property>
              <Property name="PasswordJavaRegEx">^[\S]{5,30}$</Property>
              <Property name="PasswordJavaScriptRegEx">^[\S]{5,30}$</Property>
              <Property name="PasswordJavaRegExViolationErrorMsg">Password length should be within 5 to 30 characters</Property>
              <Property name="RolenameJavaRegEx">^[\S]{3,30}$</Property>
              <Property name="RolenameJavaScriptRegEx">^[\S]{3,30}$</Property>
              <Property name="CaseInsensitiveUsername">false</Property>
              <Property name="SCIMEnabled">false</Property>
              <Property name="IsBulkImportSupported">false</Property>
              <Property name="PasswordDigest">SHA-256</Property>
              <Property name="StoreSaltedPassword">true</Property>
              <Property name="MultiAttributeSeparator">,</Property>
              <Property name="MaxUserNameListLength">100</Property>
              <Property name="MaxRoleNameListLength">100</Property>
              <Property name="UserRolesCacheEnabled">true</Property>
              <Property name="UserNameUniqueAcrossTenants">false</Property>
              <Property name="LeadingOrTrailingSpaceAllowedInUserName">false</Property>
            </UserStoreManager>
        - operation: comment
          xpath : "Realm/UserStoreManager[@class=\"org.wso2.carbon.user.core.ldap.ReadWriteLDAPUserStoreManager\"]"
          value:  ~
    - file_path: "is/identity-server-deployment.yaml"
      relative_path: ~
      file_type: txt
      configurations:
        - operation: replace
          current_value: "{$arg.existing_version_wso2is}"
          new_value: "{$arg.new_version_wso2is}"

    - file_path: "is-with-analytics/confs/is/conf/carbon.xml"
      relative_path: "{$arg.wso2is}/repository/conf/carbon.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "HostName"
          value: "wso2is"
        - operation: replace
          xpath: "MgtHostName"
          value: "wso2is"
    - file_path: "is-with-analytics/confs/is/conf/datasources/master-datasources.xml"
      relative_path: "{$arg.wso2is}/repository/conf/datasources/master-datasources.xml"
      file_type: "xml"
      configurations:
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_REG_DS</name>
                <description>The datasource used for registry</description>
                <jndiConfig>
                    <name>jdbc/WSO2RegDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2IS_REG_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_USER_DS</name>
                <description>The datasource used for user management</description>
                <jndiConfig>
                    <name>jdbc/WSO2UserDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2IS_USER_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_IDENTITY_DS</name>
                <description>The datasource used for identity management</description>
                <jndiConfig>
                    <name>jdbc/WSO2IdentityDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2IS_IDENTITY_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>WSO2_CONSENT_DS</name>
                <description>The datasource used for consent management</description>
                <jndiConfig>
                    <name>jdbc/WSO2ConsentDS</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2IS_CONSENT_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>80</maxActive>
                        <maxWait>60000</maxWait>
                        <minIdle>5</minIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
    - file_path: "is-with-analytics/confs/is/conf/datasources/bps-datasources.xml"
      relative_path: "{$arg.wso2is}/repository/conf/datasources/bps-datasources.xml"
      file_type: "xml"
      configurations:
        - operation: comment
          xpath: "datasources/datasource[name=\"BPS_DS\"]"
          value: ~
        - operation: add
          xpath: "datasources"
          value:
            |
            <datasource>
                <name>BPS_DS</name>
                <description></description>
                <jndiConfig>
                    <name>bpsds</name>
                </jndiConfig>
                <definition type="RDBMS">
                    <configuration>
                        <url>jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2IS_BPS_DB?autoReconnect=true&amp;useSSL=false</url>
                        <username>wso2carbon</username>
                        <password>wso2carbon</password>
                        <driverClassName>com.mysql.jdbc.Driver</driverClassName>
                        <maxActive>100</maxActive>
                        <maxWait>10000</maxWait>
                        <maxIdle>20</maxIdle>
                        <testOnBorrow>true</testOnBorrow>
                        <validationQuery>SELECT 1</validationQuery>
                        <validationInterval>30000</validationInterval>
                        <useDataSourceFactory>false</useDataSourceFactory>
                        <defaultAutoCommit>false</defaultAutoCommit>
                    </configuration>
                </definition>
            </datasource>
    - file_path: "is-with-analytics/confs/is/conf/consent-mgt-config.xml"
      relative_path: "{$arg.wso2is}/repository/conf/consent-mgt-config.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "DataSource/Name"
          value: 'jdbc/WSO2ConsentDS'
    - file_path: "is-with-analytics/confs/is/conf/log4j.properties"
      relative_path: "{$arg.wso2is}/repository/conf/log4j.properties"
      file_type: "txt"
      configurations:
        - operation: add
          current_value: "java.util.logging.ConsoleHandler.level=SEVERE"
          new_value: "log4j.logger.com.hazelcast=INFO"
    - file_path: "is-with-analytics/confs/is/conf/registry.xml"
      relative_path: "{$arg.wso2is}/repository/conf/registry.xml"
      file_type: "xml"
      configurations:
        - operation: add
          xpath: "."
          value:
            |
            <dbConfig name="sharedregistry">
                <dataSource>jdbc/WSO2RegDS</dataSource>
            </dbConfig>
        - operation: add
          xpath: "."
          value:
            |
            <remoteInstance url="https://localhost:9443/registry">
                <id>sharedregistry</id>
                <dbConfig>sharedregistry</dbConfig>
                <readOnly>false</readOnly>
                <registryRoot>/</registryRoot>
                <enableCache>true</enableCache>
                <cacheId>jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2IS_IDENTITY_DB</cacheId>
            </remoteInstance>
        - operation: add
          xpath: "."
          value:
            |
            <mount path="/_system/config" overwrite="true">
                <instanceId>sharedregistry</instanceId>
                <targetPath>/_system/is/config</targetPath>
            </mount>
        - operation: add
          xpath: "."
          value:
            |
            <mount path="/_system/governance" overwrite="true">
                <instanceId>sharedregistry</instanceId>
                <targetPath>/_system/governance</targetPath>
            </mount>
    - file_path: "is-with-analytics/confs/is/conf/user-mgt.xml"
      relative_path: "{$arg.wso2is}/repository/conf/user-mgt.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "Realm/Configuration/Property[@name=\"dataSource\"]"
          value: "jdbc/WSO2IdentityDS"
        - operation: add
          xpath: "Realm"
          value:
            |
            <UserStoreManager class="org.wso2.carbon.user.core.jdbc.JDBCUserStoreManager">
              <Property name="TenantManager">org.wso2.carbon.user.core.tenant.JDBCTenantManager</Property>
              <Property name="dataSource">jdbc/WSO2UserDS</Property>
              <Property name="ReadOnly">false</Property>
              <Property name="ReadGroups">true</Property>
              <Property name="WriteGroups">true</Property>
              <Property name="UsernameJavaRegEx">^[\S]{3,30}$</Property>
              <Property name="UsernameJavaScriptRegEx">^[\S]{3,30}$</Property>
              <Property name="UsernameJavaRegExViolationErrorMsg">Username pattern policy violated</Property>
              <Property name="PasswordJavaRegEx">^[\S]{5,30}$</Property>
              <Property name="PasswordJavaScriptRegEx">^[\S]{5,30}$</Property>
              <Property name="PasswordJavaRegExViolationErrorMsg">Password length should be within 5 to 30 characters</Property>
              <Property name="RolenameJavaRegEx">^[\S]{3,30}$</Property>
              <Property name="RolenameJavaScriptRegEx">^[\S]{3,30}$</Property>
              <Property name="CaseInsensitiveUsername">false</Property>
              <Property name="SCIMEnabled">false</Property>
              <Property name="IsBulkImportSupported">false</Property>
              <Property name="PasswordDigest">SHA-256</Property>
              <Property name="StoreSaltedPassword">true</Property>
              <Property name="MultiAttributeSeparator">,</Property>
              <Property name="MaxUserNameListLength">100</Property>
              <Property name="MaxRoleNameListLength">100</Property>
              <Property name="UserRolesCacheEnabled">true</Property>
              <Property name="UserNameUniqueAcrossTenants">false</Property>
              <Property name="LeadingOrTrailingSpaceAllowedInUserName">false</Property>
            </UserStoreManager>
        - operation: comment
          xpath : "Realm/UserStoreManager[@class=\"org.wso2.carbon.user.core.ldap.ReadWriteLDAPUserStoreManager\"]"
          value:  ~
    - file_path: "is-with-analytics/confs/is/conf/axis2/axis2.xml"
      relative_path: "{$arg.wso2is}/repository/conf/axis2/axis2.xml"
      file_type: xml
      configurations:
        - operation: attribute
          xpath: "clustering[@class=\"org.wso2.carbon.core.clustering.hazelcast.HazelcastClusteringAgent\"]"
          value: "enable=true"
        - operation: replace
          xpath: "clustering/parameter[@name=\"membershipScheme\"]"
          value: "kubernetes"
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="membershipSchemeClassName">org.wso2.carbon.membership.scheme.kubernetes.KubernetesMembershipScheme</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="KUBERNETES_NAMESPACE">wso2</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="KUBERNETES_SERVICES">wso2is-with-analytics-is-service</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="KUBERNETES_MASTER_SKIP_SSL_VERIFICATION">true</parameter>
        - operation: add
          xpath: "clustering"
          value: |
            <parameter name="USE_DNS">false</parameter>
        - operation: replace
          xpath: "clustering/parameter[@name=\"domain\"]"
          value: "wso2.is.domain"
        - operation: replace
          xpath: "clustering/parameter[@name=\"localMemberHost\"]"
          value: "identity-server"
        - operation: "comment"
          xpath: "clustering/members"
          value: ~
    - file_path: "is-with-analytics/confs/is/conf/identity/identity.xml"
      relative_path: "{$arg.wso2is}/repository/conf/identity/identity.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "JDBCPersistenceManager/DataSource/Name"
          value: 'jdbc/WSO2IdentityDS'
  # TODO: listener configurations
    - file_path: "is-with-analytics/confs/is/conf/identity/identity-event.properties"
      relative_path: "{$arg.wso2is}/repository/conf/identity/identity-event.properties"
      file_type: "txt"
      configurations:
        - operation: replace
          current_value: "analyticsLoginDataPublisher.enable=false"
          new_value: "analyticsLoginDataPublisher.enable=true"
        - operation: replace
          current_value: "analyticsSessionDataPublisher.enable=false"
          new_value: "analyticsSessionDataPublisher.enable=true"
    - file_path: "is-with-analytics/confs/is/conf/tomcat/catalina-server.xml"
      relative_path: "{$arg.wso2is}/repository/conf/tomcat/catalina-server.xml"
      file_type: "xml"
      configurations:
        - operation: attribute
          xpath: "Service/Connector[@scheme=\"https\"]"
          value: "proxyPort=443"
    - file_path: "is-with-analytics/confs/is/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-AuthenticationData.xml"
      relative_path: "{$arg.wso2is}/repository/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-AuthenticationData.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "to/property[@name=\"receiverURL\"]"
          value: "tcp://wso2is-with-analytics-is-analytics-service:7612"
    - file_path: "is-with-analytics/confs/is/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-UserData.xml"
      relative_path: "{$arg.wso2is}/repository/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-UserData.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "to/property[@name=\"receiverURL\"]"
          value: "tcp://wso2is-with-analytics-is-analytics-service:7612"
    - file_path: "is-with-analytics/confs/is/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-RoleData.xml"
      relative_path: "{$arg.wso2is}/repository/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-RoleData.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "to/property[@name=\"receiverURL\"]"
          value: "tcp://wso2is-with-analytics-is-analytics-service:7612"
    - file_path: "is-with-analytics/confs/is/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-SessionData.xml"
      relative_path: "{$arg.wso2is}/repository/deployment/server/eventpublishers/IsAnalytics-Publisher-wso2event-SessionData.xml"
      file_type: "xml"
      configurations:
        - operation: replace
          xpath: "to/property[@name=\"receiverURL\"]"
          value: "tcp://wso2is-with-analytics-is-analytics-service:7612"
    - file_path: "is-with-analytics/confs/is-analytics-worker/conf/worker/deployment.yaml"
      relative_path: "{$arg.wso2is-analytics}/conf/worker/deployment.yaml"
      file_type: "yaml"
      configurations:
        - operation: replace
          xpath: "wso2.carbon/id"
          value: "${NODE_ID}"
        - operation: update
          xpath: "."
          value:
            |
            siddhi.stores.query.api:
              transportProperties:
                -
                  name: "server.bootstrap.socket.timeout"
                  value: 60
                -
                  name: "client.bootstrap.socket.timeout"
                  value: 60
                -
                  name: "latency.metrics.enabled"
                  value: true

              listenerConfigurations:
                -
                  id: "default"
                  host: "0.0.0.0"
                  port: 7070
                -
                  id: "msf4j-https"
                  host: "0.0.0.0"
                  port: 7443
                  scheme: https
                  keyStoreFile: "${carbon.home}/resources/security/wso2carbon.jks"
                  keyStorePassword: wso2carbon
                  certPass: wso2carbon
        - operation: replace
          xpath: "databridge.config/dataReceivers/dataReceiver[type=\"Binary\"]/properties/hostName"
          value: "${NODE_IP}"
        - operation: replace
          xpath: "wso2.metrics/enabled"
          value: "true"
        - operation: replace
          xpath: "wso2.metrics.jdbc/dataSource[dataSourceName=\"java:comp/env/jdbc/WSO2MetricsDB\"]/scheduledCleanup/daysToKeep"
          value: 7
        - operation: replace
          xpath: "state.persistence/enabled"
          value: true
        - operation: replace
          xpath: "state.persistence/persistenceStore"
          value: "org.wso2.carbon.stream.processor.core.persistence.DBPersistenceStore"
#        - operation: comment
#          xpath : "state.persistence/config/location"
#          value:  ~
#        - operation: update
#          xpath: "state.persistence/config"
#          value:
#            |
#            datasource: SP_WORKER_STATE_DB
#            table: PERSISTENCE_TABLE
        - operation: add
          xpath: "wso2.datasources/dataSources"
          value:
            |
            name: WSO2_CLUSTER_DB
            description: The MySQL datasource used for Cluster Coordination
            jndiConfig:
              name: jdbc/WSO2ClusterDB
            definition:
              type: RDBMS
              configuration:
                jdbcUrl: 'jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2_CLUSTER_DB?useSSL=false'
                username: wso2carbon
                password: wso2carbon
                driverClassName: com.mysql.jdbc.Driver
                maxPoolSize: 50
                idleTimeout: 60000
                connectionTestQuery: SELECT 1
                validationTimeout: 30000
                isAutoCommit: false
        - operation: add
          xpath: "wso2.datasources/dataSources"
          value:
            |
            name: WSO2_PERSISTENCE_DB
            description: The MySQL datasource used for system persistence
            jndiConfig:
              name: jdbc/WSO2PersistenceDB
            definition:
              type: RDBMS
              configuration:
                jdbcUrl: 'jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/WSO2_PERSISTENCE_DB?useSSL=false'
                username: wso2carbon
                password: wso2carbon
                driverClassName: com.mysql.jdbc.Driver
                maxPoolSize: 50
                idleTimeout: 60000
                connectionTestQuery: SELECT 1
                validationTimeout: 30000
                isAutoCommit: false
        - operation: replace
          xpath : "wso2.datasources/dataSources[name=\"IS_ANALYTICS_DB\"]/definition/configuration/jdbcUrl"
          value:  "jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/IS_ANALYTICS_DB?useSSL=false"
        - operation: replace
          xpath : "wso2.datasources/dataSources[name=\"IS_ANALYTICS_DB\"]/definition/configuration/driverClassName"
          value:  "com.mysql.jdbc.Driver"
        - operation: replace
          xpath: "cluster.config/enabled"
          value: "true"
        - operation: update
          xpath: "."
          value:
            |
            deployment.config:
              type: ha
              eventByteBufferQueueCapacity: 20000
              byteBufferExtractorThreadPoolSize: 5
              eventSyncServer:
                host: ${NODE_IP}
                port: 9894
                bossThreads: 10
                workerThreads: 10
              eventSyncClientPool:
                maxActive: 10
                maxTotal: 10
                maxIdle: 10
                maxWait: 60000
                minEvictableIdleTimeMillis: 120000
    - file_path: "is-with-analytics/confs/is-analytics-dashboard/conf/dashboard/deployment.yaml"
      relative_path: "{$arg.wso2is-analytics}/conf/dashboard/deployment.yaml"
      file_type: "yaml"
      configurations:
        - operation: replace
          xpath : "wso2.datasources/dataSources[name=\"IS_ANALYTICS_DB\"]/definition/configuration/jdbcUrl"
          value:  "jdbc:mysql://wso2is-with-analytics-rdbms-service:3306/IS_ANALYTICS_DB?useSSL=false"
        - operation: replace
          xpath : "wso2.datasources/dataSources[name=\"IS_ANALYTICS_DB\"]/definition/configuration/driverClassName"
          value:  "com.mysql.jdbc.Driver"
    - file_path: "is-with-analytics/is-analytics-dashboard/identity-server-analytics-dashboard-deployment.yaml"
      relative_path: ~
      file_type: txt
      configurations:
        - operation: replace
          current_value: "{$arg.existing_version_wso2is-analytics}"
          new_value: "{$arg.new_version_wso2is-analytics}"
    - file_path: "is-with-analytics/is-analytics-worker/identity-server-analytics-worker-deployment.yaml"
      relative_path: ~
      file_type: txt
      configurations:
        - operation: replace
          current_value: "{$arg.existing_version_wso2is-analytics}"
          new_value: "{$arg.new_version_wso2is-analytics}"
    - file_path: "is-with-analytics/is/identity-server-deployment.yaml"
      relative_path: ~
      file_type: txt
      configurations:
        - operation: replace
          current_value: "{$arg.existing_version_wso2is}"
          new_value: "{$arg.new_version_wso2is}"
